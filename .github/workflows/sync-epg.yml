name: Sync EPG (TR)

on:
  schedule:
    - cron: "0 * * * *"   # Her saat (UTC). İstersen "*/30 * * * *" yapabilirsin.
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout data branch
        uses: actions/checkout@v4
        with:
          ref: data
          fetch-depth: 0

      - name: Download & validate & update
        env:
          EPG_URL: https://epg.tvcdn.net/guide/tr-guide.xml
          TARGET: epg.xml
        run: |
          set -euo pipefail

          TMP="${TARGET}.new"

          # İndir (retry + sıkıştırma desteği)
          curl -L --fail --retry 5 --retry-delay 10 --compressed \
               -H "User-Agent: FreeIPTV_TR/Sync (+github-actions)" \
               "$EPG_URL" -o "$TMP"

          # Basit XML doğrulaması (tek satır, here-doc yok)
          python -c "import xml.etree.ElementTree as ET; ET.parse('${TARGET}.new')"

          # Değişmediyse çık
          if [ -f "$TARGET" ] && cmp -s "$TMP" "$TARGET"; then
            echo "No change"
            rm -f "$TMP"
            exit 0
          fi

          # Güncelle ve .gz üret
          mv -f "$TMP" "$TARGET"
          gzip -c "$TARGET" > "${TARGET}.gz"

      - name: Commit & push if changed (to data)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "Nothing to commit"
            exit 0
          fi

          MSG="update: epg.xml $(TZ='Europe/Istanbul' date '+%Y-%m-%d %H:%M %z')"
          git commit -m "$MSG"
          git push origin HEAD:data
